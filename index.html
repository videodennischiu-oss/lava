<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>火山跳躍 | Volcano Jump</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700;900&family=Cinzel:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{background:#0a0005;display:flex;justify-content:center;align-items:center;height:100vh;overflow:hidden;font-family:'Cinzel',serif;}
#game-container{position:relative;width:420px;height:748px;}
canvas{display:block;}

#ui-overlay{position:absolute;top:0;left:0;right:0;bottom:0;pointer-events:none;z-index:10;}

/* HUD */
#score-display{position:absolute;top:10px;left:16px;display:none;pointer-events:none;}
#score-label{color:rgba(255,160,80,.6);font-size:9px;letter-spacing:3px;}
#score-value{color:#ffd700;font-family:'Cinzel Decorative',cursive;font-size:26px;font-weight:900;}

#lang-btn{position:absolute;top:10px;right:12px;pointer-events:all;
  background:linear-gradient(145deg,#1c0500,#4a1000);border:2px solid #ff6b00;color:#ffd700;
  padding:6px 14px;border-radius:30px;cursor:pointer;z-index:100;}

/* 控制按鈕 */
#controls{position:absolute;bottom:0;left:0;right:0;height:220px;display:none;pointer-events:none;}
.dpad-btn, #btn-jump, #btn-use{pointer-events:all;user-select:none;}
#dpad{position:absolute;bottom:30px;left:20px;width:150px;height:150px;}
.dpad-btn{position:absolute;width:55px;height:55px;background:rgba(80,20,0,0.7);border:2px solid #ff6b00;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#ffd700;font-size:24px;}
#btn-up{left:50px;top:0;}
#btn-left2{left:0;top:60px;}
#btn-right2{right:100px;top:60px;}

#right-btns{position:absolute;bottom:30px;right:20px;width:130px;height:150px;}
#btn-jump{position:absolute;top:0;right:0;width:90px;height:90px;border-radius:50%;background:linear-gradient(145deg,#8b2200,#4a1000);border:3px solid #ff8800;color:#ff8800;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 5px 15px rgba(0,0,0,0.5);}

/* 特效與選單 */
#danger-flash{position:absolute;inset:0;pointer-events:none;z-index:5;transition: background 0.2s;}
#menu-screen, #gameover-screen{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(0,0,0,0.85);z-index:200;pointer-events:all;}
.luxury-btn{background:linear-gradient(160deg,#8b2200,#2a0500);padding:16px 50px;border-radius:50px;border:2px solid #ffd700;color:#ffd700;cursor:pointer;font-family:'Cinzel Decorative';font-size:20px;}
</style>
</head>
<body>
<div id="game-container">
  <div id="ui-overlay">
    <div id="score-display"><div id="score-label">HEIGHT</div><div id="score-value">0</div></div>
    <button id="lang-btn">EN / 中</button>
    <div id="danger-flash"></div>

    <div id="controls">
      <div id="dpad">
        <div class="dpad-btn" id="btn-up">▲</div>
        <div class="dpad-btn" id="btn-left2">◀</div>
        <div class="dpad-btn" id="btn-right2">▶</div>
      </div>
      <div id="right-btns"><div id="btn-jump">JUMP</div></div>
    </div>

    <div id="menu-screen">
      <h1 style="color:#ffd700;font-size:42px;margin-bottom:30px;text-align:center;">VOLCANO<br>JUMP</h1>
      <button class="luxury-btn" id="start-btn">PLAY</button>
    </div>

    <div id="gameover-screen" style="display:none">
      <h2 style="color:#ff3300;margin-bottom:10px;">GAME OVER</h2>
      <div style="color:#ffd700;font-size:50px;margin-bottom:20px;" id="final-score">0</div>
      <button class="luxury-btn" id="retry-btn">RETRY</button>
    </div>
  </div>
</div>

<script>
/* ═══════ 核心場景 ═══════ */
class MainScene extends Phaser.Scene {
  constructor() { super('MainScene'); }
  
  create() {
    this.score = 0;
    this.alive = true;
    this.lavaY = 900; // 降低初始岩漿位置
    this.platforms = this.physics.add.staticGroup();
    
    // 1. 強制生成起始安全平台
    this.platforms.create(210, 650, 'plat_wide').setScale(2.5, 1).refreshBody();

    // 2. 隨機生成上方平台
    for(let i=1; i<20; i++) {
        let x = Phaser.Math.Between(60, 360);
        let y = 650 - (i * 130);
        this.platforms.create(x, y, 'plat');
    }

    // 3. 玩家初始位置調高
    this.player = this.physics.add.sprite(210, 450, 'hero');
    this.player.setBounce(0.1);
    this.physics.add.collider(this.player, this.platforms, (p, plat) => {
        if(p.body.touching.down) p.setVelocityY(-620); // 碰撞即彈跳
    });

    this.cameras.main.startFollow(this.player, true, 0, 0.1, 0, 150);
    this.lavaGfx = this.add.graphics().setDepth(5);
    
    this.setupControls();
  }

  setupControls() {
    this.moveL = false; this.moveR = false;
    const bind = (id, start, end) => {
        let el = document.getElementById(id);
        el.onpointerdown = start; el.onpointerup = end; el.onpointerout = end;
    };
    bind('btn-left2', () => this.moveL = true, () => this.moveL = false);
    bind('btn-right2', () => this.moveR = true, () => this.moveR = false);
    document.getElementById('btn-jump').onpointerdown = () => {
        if(this.player.body.touching.down) this.player.setVelocityY(-750);
    };
    this.cursors = this.input.keyboard.createCursorKeys();
  }

  update() {
    if(!this.alive) return;
    
    // 左右移動控制
    if(this.moveL || this.cursors.left.isDown) this.player.setVelocityX(-280);
    else if(this.moveR || this.cursors.right.isDown) this.player.setVelocityX(280);
    else this.player.setVelocityX(0);

    // 岩漿緩慢上升
    this.lavaY -= 0.7 + (this.score / 600);
    this.drawLava();

    // 計分系統
    let currentHeight = Math.floor((450 - this.player.y) / 10);
    if(currentHeight > this.score) {
        this.score = currentHeight;
        document.getElementById('score-value').textContent = this.score;
    }

    // 邊界傳送 (螢幕左右互通)
    if(this.player.x < 0) this.player.x = 420;
    if(this.player.x > 420) this.player.x = 0;

    // 死亡判定
    if(this.player.y > this.lavaY) this.gameOver();
  }

  drawLava() {
    this.lavaGfx.clear();
    this.lavaGfx.fillStyle(0xff2200, 0.85);
    let screenLavaY = this.lavaY - this.cameras.main.scrollY;
    this.lavaGfx.fillRect(0, screenLavaY, 420, 1000);
    
    // 危機閃爍提醒
    let dist = this.lavaY - this.player.y;
    let alpha = Phaser.Math.Clamp(1 - (dist / 350), 0, 0.7);
    document.getElementById('danger-flash').style.background = `rgba(255,0,0,${alpha})`;
  }

  gameOver() {
    this.alive = false;
    document.getElementById('final-score').textContent = this.score;
    document.getElementById('gameover-screen').style.display = 'flex';
    document.getElementById('controls').style.display = 'none';
  }
}

/* ═══════ 啟動與材質生成 ═══════ */
class BootScene extends Phaser.Scene {
    constructor() { super('BootScene'); }
    create() {
        let g = this.make.graphics({add:false});
        // 角色材質
        g.fillStyle(0xffcc00); g.fillCircle(15, 15, 15);
        g.fillStyle(0x000000); g.fillCircle(10, 12, 2); g.fillCircle(20, 12, 2);
        g.generateTexture('hero', 30, 30);
        // 平台材質
        g.clear(); g.fillStyle(0x884422); g.fillRoundedRect(0, 0, 80, 15, 4);
        g.generateTexture('plat', 80, 15);
        g.generateTexture('plat_wide', 160, 15);
        
        this.scene.start('MainScene');
    }
}

const cfg = {
  type: Phaser.AUTO, width: 420, height: 748,
  parent: 'game-container',
  physics: { default: 'arcade', arcade: { gravity: { y: 1100 } } },
  scene: [BootScene, MainScene]
};

document.getElementById('start-btn').onclick = () => {
    document.getElementById('menu-screen').style.display = 'none';
    document.getElementById('score-display').style.display = 'block';
    document.getElementById('controls').style.display = 'block';
    if(!phaserGame) phaserGame = new Phaser.Game(cfg);
    else phaserGame.scene.start('BootScene');
};

document.getElementById('retry-btn').onclick = () => {
    document.getElementById('gameover-screen').style.display = 'none';
    document.getElementById('controls').style.display = 'block';
    phaserGame.scene.start('BootScene');
};
</script>
</body>
</html>
